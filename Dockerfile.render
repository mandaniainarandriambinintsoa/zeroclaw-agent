# syntax=docker/dockerfile:1.7
# ZeroClaw - Agent Autonome Complet
# Optimized for Render Free Tier with git + gh CLI

# ── Stage 1: Build ────────────────────────────────────────────
FROM rust:1.93-slim AS builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y \
        pkg-config \
    && rm -rf /var/lib/apt/lists/*

# 1. Copy manifests first for dependency caching
COPY Cargo.toml Cargo.lock rust-toolchain.toml ./
COPY crates/robot-kit/Cargo.toml crates/robot-kit/Cargo.toml

# Create dummy targets for dependency caching
RUN mkdir -p src benches crates/robot-kit/src \
    && echo "fn main() {}" > src/main.rs \
    && echo "fn main() {}" > benches/agent_benchmarks.rs \
    && echo "pub fn placeholder() {}" > crates/robot-kit/src/lib.rs

RUN cargo build --release --locked
RUN rm -rf src benches crates/robot-kit/src

# 2. Copy actual source and build
COPY src/ src/
COPY benches/ benches/
COPY crates/ crates/
COPY firmware/ firmware/

RUN cargo build --release --locked && \
    cp target/release/zeroclaw /app/zeroclaw && \
    strip /app/zeroclaw

# Prepare runtime directory
RUN mkdir -p /zeroclaw-data/.zeroclaw /zeroclaw-data/workspace /zeroclaw-data/credentials

COPY config.toml /zeroclaw-data/.zeroclaw/config.toml
COPY workspace/ /zeroclaw-data/workspace/
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh && chown -R 65534:65534 /zeroclaw-data

# ── Stage 2: Production Runtime (Debian slim) ─────────────────
FROM debian:trixie-slim AS production

# Install runtime deps: ca-certificates, curl, git, gh CLI
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    git \
    gpg \
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
       | gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
       > /etc/apt/sources.list.d/github-cli.list \
    && apt-get update && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/zeroclaw /usr/local/bin/zeroclaw
COPY --from=builder /usr/local/bin/entrypoint.sh /usr/local/bin/entrypoint.sh
COPY --from=builder /zeroclaw-data /zeroclaw-data

# Environment setup
ENV ZEROCLAW_WORKSPACE=/zeroclaw-data/workspace
ENV HOME=/zeroclaw-data
ENV PROVIDER=groq
ENV ZEROCLAW_MODEL=gpt-4o-mini
ENV ZEROCLAW_GATEWAY_PORT=3000
ENV ZEROCLAW_ALLOW_PUBLIC_BIND=true

# Render uses PORT env var
ENV PORT=3000

WORKDIR /zeroclaw-data
USER 65534:65534
EXPOSE 3000

# Health check for Render
HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=15s \
    CMD curl -f http://localhost:3000/health || exit 1

ENTRYPOINT ["entrypoint.sh"]
CMD ["daemon"]
